name: Fetch Weather Data

on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fetch:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Fetch weather data
        run: |
          END=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          START=$(date -u -d '1 hour ago' +%Y-%m-%dT%H:%M:%SZ)

          curl -sf -X POST \
            'https://461.sensors.axds.co/api/observations/filter/custom' \
            -H 'Content-Type: application/json' \
            -d "{\"filter\":{\"stations\":[57163]},\"start\":\"$START\",\"end\":\"$END\"}" \
          | python3 - <<'PYEOF'
          import json, sys
          from datetime import datetime, timezone

          raw = json.load(sys.stdin)
          feeds = raw.get("data", {}).get("groupedFeeds", [])

          # Map sensorParameterId to output key and which index holds the value
          WANT = {
              3: ("temperature_c", 1),
              339: ("rain_mm", 1),
              5: ("wind_speed_ms", 1),
              6: ("wind_direction_deg", 3),
              370: ("wind_gust_ms", 1),
          }

          result = {}
          latest_time = None

          for group in feeds:
              meta_values = group.get("metadata", {}).get("values", [])
              pid_to_idx = {}
              for v in meta_values:
                  pid = v["sensorParameterId"]
                  if pid in WANT:
                      pid_to_idx[pid] = WANT[pid]

              if not pid_to_idx:
                  continue

              data = group.get("data", [])
              if not data:
                  continue

              last_row = data[-1]
              ts = last_row[0]  # ISO timestamp string
              if latest_time is None or ts > latest_time:
                  latest_time = ts

              for pid, (key, idx) in pid_to_idx.items():
                  if idx < len(last_row):
                      result[key] = last_row[idx]

          result["timestamp"] = latest_time
          result["fetched_at"] = datetime.now(timezone.utc).isoformat()

          with open("data.json", "w") as f:
              json.dump(result, f, indent=2)
              f.write("\n")

          print(json.dumps(result, indent=2))
          PYEOF

      - name: Commit if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data.json
          git diff --cached --quiet && echo "No changes" && exit 0
          git commit -m "Update weather data"
          git push
